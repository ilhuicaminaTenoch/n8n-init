{
  "updatedAt": "2025-11-28T22:17:08.815Z",
  "createdAt": "2025-11-28T20:55:19.764Z",
  "id": "8gP78fW1rv7UB5v9",
  "name": "Crear Cita",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "/crear-cita",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        0,
        224
      ],
      "id": "6fe5efa1-e514-4346-b445-fa65e0e951fa",
      "name": "Webhook",
      "webhookId": "a01a0f86-b582-496a-a87c-7a1725f8e523"
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "26511fe382958416668b7d02b1e0c4906a89ff2317546d62eec3f4e4a6a8c70a@group.calendar.google.com",
          "mode": "list",
          "cachedResultName": "n8n test"
        },
        "start": "={{ $('Construir DateTime').item.json.startDateTime }}",
        "end": "={{ $('Construir DateTime').item.json.endDateTime }}",
        "additionalFields": {
          "description": "={{ $json.nombre_cliente }} ",
          "summary": "=V√≠sita t√©cnica  {{ $json.tipo_servicio }} - {{ $json.nombre_cliente }}"
        }
      },
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        896,
        224
      ],
      "id": "0665d3ca-3d36-475b-b29e-e45e50d69c03",
      "name": "Create an event",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "oxbrcrpqzta3DGxS",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "06172830-8655-4741-aa76-261715a07be7",
              "name": "status",
              "value": "=confirmed",
              "type": "string"
            },
            {
              "id": "49130130-55b3-4c80-b50a-286d10b3e43d",
              "name": "event_id",
              "value": "={{ $json.id }}",
              "type": "string"
            },
            {
              "id": "ad25366e-b338-443e-a05f-d71b57f77dde",
              "name": "fecha_inicio",
              "value": "={{ $json.start.dateTime }}",
              "type": "string"
            },
            {
              "id": "33afcd98-c66b-4fdc-b0e3-a7951eb511d5",
              "name": "fecha_fin",
              "value": "={{ $json.end.dateTime }}",
              "type": "string"
            },
            {
              "id": "224b5674-f351-4909-a1f0-b9593c313859",
              "name": "link_calendario",
              "value": "={{ $json.htmlLink }}",
              "type": "string"
            },
            {
              "id": "970bcdf7-3aa2-47c9-9ef6-6db31601c4da",
              "name": "cita_id",
              "value": "={{ $('Insertar Cita').item.json.id }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1136,
        224
      ],
      "id": "e184b33a-98dd-4e17-abb8-f4e17d13b283",
      "name": "Formatear Respuesta"
    },
    {
      "parameters": {
        "jsCode": "// C√≥digo corregido para el nodo Code\nconst fecha = $('Webhook').first().json.body.fecha_preferida;;\nconst rango = $('Webhook').first().json.body.hora_preferida;\n\n// Validar que tenemos los datos necesarios\nif (!fecha || !rango) {\n  throw new Error('Faltan datos requeridos: fecha_entrega o hora_preferida');\n}\n\nconst [horaInicio, horaFin] = rango.split('-');\nif (!horaInicio || !horaFin) {\n  throw new Error('Formato de hora_preferida inv√°lido. Use HH:MM-HH:MM');\n}\n\n// Validar que sea exactamente 1 hora\nconst inicio = new Date(`${fecha}T${horaInicio}:00`);\nconst fin = new Date(`${fecha}T${horaFin}:00`);\nconst diffHoras = (fin - inicio) / (1000 * 60 * 60);\n\nif (diffHoras !== 1) {\n  throw new Error(`El rango debe ser exactamente 1 hora. Recibido: ${diffHoras} horas`);\n}\n\n// Helper para timezone offset\nfunction getOffsetString(date) {\n  const offsetMin = -date.getTimezoneOffset();\n  const sign = offsetMin >= 0 ? '+' : '-';\n  const abs = Math.abs(offsetMin);\n  const hh = String(Math.floor(abs / 60)).padStart(2, '0');\n  const mm = String(abs % 60).padStart(2, '0');\n  return `${sign}${hh}:${mm}`;\n}\n\nconst offset = getOffsetString(inicio);\nconst startDateTime = `${fecha}T${horaInicio}:00.000${offset}`;\nconst endDateTime = `${fecha}T${horaFin}:00.000${offset}`;\n\nreturn [{\n  ...$json,\n  // Para Postgres\n  hora_inicio: `${horaInicio}:00`,\n  hora_fin: `${horaFin}:00`,\n  estado: 'confirmado',\n  created_at: new Date().toISOString(),\n  // Para Google Calendar\n  startDateTime,\n  endDateTime,\n  // Datos originales para referencia\n  body: $('Webhook').first().json.body\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        448,
        224
      ],
      "id": "8304d800-fae9-48bb-bc87-cb41fa95abca",
      "name": "Construir DateTime"
    },
    {
      "parameters": {
        "jsCode": "// NUEVO NODO CODE - Validaci√≥n\nconst body = $('Webhook').first().json.body;\n\n// 1. Validar campos requeridos\nconst required = ['nombre', 'telefono', 'email', 'tipo_servicio', 'fecha_preferida', 'hora_preferida', 'direccion'];\nconst missing = required.filter(field => !body[field] || body[field].trim() === '');\n\nif (missing.length > 0) {\n  throw new Error(`Faltan campos obligatorios: ${missing.join(', ')}. Por favor completa todos los datos.`);\n}\n\nconst emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\nif (!emailRegex.test(body.email)) {\n  throw new Error('Formato de email inv√°lido. Debe ser un email v√°lido (ej: usuario@dominio.com)');\n}\n\n// Validar formato de fecha (YYYY-MM-DD)\nconst fechaRegex = /^\\d{4}-\\d{2}-\\d{2}$/;\nif (!fechaRegex.test(body.fecha_preferida)) {\n  throw new Error('Formato de fecha inv√°lido. Debe ser YYYY-MM-DD (ej: 2024-01-15)');\n}\n\n// Validar formato de hora (HH:MM-HH:MM) y que sea 1 hora exacta\nconst horaRegex = /^([0-1][0-9]|2[0-3]):[0-5][0-9]-([0-1][0-9]|2[0-3]):[0-5][0-9]$/;\nif (!horaRegex.test(body.hora_preferida)) {\n  throw new Error('Formato de hora inv√°lido. Debe ser HH:MM-HH:MM (ej: 14:00-15:00)');\n}\n\n// Validar que sea exactamente 1 hora\nconst [inicio, fin] = body.hora_preferida.split('-');\nconst diff = (parseInt(fin.split(':')[0]) * 60 + parseInt(fin.split(':')[1])) - \n             (parseInt(inicio.split(':')[0]) * 60 + parseInt(inicio.split(':')[1]));\n             \nif (diff !== 60) {\n  throw new Error('El rango horario debe ser exactamente de 1 hora (ej: 14:00-15:00)');\n}\n\n// 5. Validar tipo de servicio\nconst serviciosValidos = ['cctv', 'control_accesos', 'deteccion_incendios'];\nif (!serviciosValidos.includes(body.tipo_servicio)) {\n  throw new Error(`Tipo de servicio inv√°lido. Debe ser uno de: ${serviciosValidos.join(', ')}`);\n}\n\n// 6. Validar tel√©fono (m√≠nimo 10 d√≠gitos)\nconst telefonoLimpio = body.telefono.replace(/\\D/g, '');\nif (telefonoLimpio.length < 10) {\n  throw new Error('El tel√©fono debe tener al menos 10 d√≠gitos');\n}\n\n// Si pasa todas las validaciones\nreturn [{ \n  body: {\n    ...body,\n    telefono: telefonoLimpio\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        224,
        224
      ],
      "id": "6ea6b5a0-03e7-4e54-8f6f-b7976d35926a",
      "name": "Validar Cita"
    },
    {
      "parameters": {
        "sendTo": "={{ $('Insertar Cita').item.json.email }}",
        "subject": "=Confirmaci√≥n de Cita T√©cnica - {{ $('Insertar Cita').item.json.nombre_cliente }}",
        "message": "=<!DOCTYPE html>\n<html>\n<head>\n    <style>\n        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; }\n        .header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }\n        .content { background: #f9f9f9; padding: 30px; }\n        .details { background: white; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #667eea; }\n        .detail-row { display: flex; margin-bottom: 10px; }\n        .detail-icon { width: 30px; font-weight: bold; }\n        .footer { background: #2d3748; color: white; padding: 20px; text-align: center; border-radius: 0 0 10px 10px; font-size: 12px; }\n        .button { background: #667eea; color: white; padding: 12px 25px; text-decoration: none; border-radius: 5px; display: inline-block; margin: 10px 0; }\n    </style>\n</head>\n<body>\n    <div class=\"header\">\n        <h1>Lucam Service</h1>\n        <p>La precisi√≥n que tu seguridad necesita</p>\n    </div>\n    \n    <div class=\"content\">\n        <h2>Hola {{ $('Insertar Cita').item.json.nombre_cliente }},</h2>\n        <p style=\"background: #48bb78; color: white; padding: 10px; border-radius: 5px; display: inline-block;\">‚úÖ CITA CONFIRMADA</p>\n        \n        <p>Tu cita t√©cnica ha sido agendada exitosamente:</p>\n        \n        <div class=\"details\">\n            <div class=\"detail-row\"><div class=\"detail-icon\">üìÖ</div><div><strong>Fecha:</strong> {{ $('Construir DateTime').item.json.body.fecha_preferida }}</div></div>\n            <div class=\"detail-row\"><div class=\"detail-icon\">‚è∞</div><div><strong>Hora:</strong> {{ $('Construir DateTime').item.json.hora_inicio }}</div></div>\n            <div class=\"detail-row\"><div class=\"detail-icon\">üìç</div><div><strong>Direcci√≥n:</strong> {{ $('Insertar Cita').item.json.direccion }}</div></div>\n            <div class=\"detail-row\"><div class=\"detail-icon\">üîß</div><div><strong>Servicio:</strong> {{ $('Insertar Cita').item.json.tipo_servicio}}</div></div>\n            <div class=\"detail-row\"><div class=\"detail-icon\">üìû</div><div><strong>Tel√©fono:</strong> {{ $('Insertar Cita').item.json.telefono }}</div></div>\n            <div class=\"detail-row\"><div class=\"detail-icon\">üìß</div><div><strong>Email:</strong> {{$('Insertar Cita').item.json.email}}</div></div>\n            <div class=\"detail-row\"><div class=\"detail-icon\">üìù</div><div><strong>Notas:</strong> {{ $('Insertar Cita').item.json.notas}}</div></div>\n            \n        </div>\n        \n        <div style=\"text-align: center; margin: 25px 0;\">\n            <a href=\"https://calendar.google.com/calendar/render?action=TEMPLATE&text=Cita+T√©cnica+{{ $('Insertar Cita').item.json.nombre_cliente }}&dates={{ $json.fecha_inicio }}/{{ $json.fecha_fin }}&details=Visita+t√©cnica+para+{{ $('Insertar Cita').item.json.tipo_servicio }}&location={{ $('Insertar Cita').item.json.direccion }}\" class=\"button\">\n                üìÖ Agregar a Google Calendar\n            </a>\n        </div>\n        \n        <p><strong>Recordatorio:</strong> Te enviaremos un recordatorio 24 horas antes.</p>\n    </div>\n    \n    <div class=\"footer\">\n        <p>Lucam Service ‚Ä¢ soporte@lucamservice.com ‚Ä¢ +52 55 1234 5678</p>\n        <p>Este es un correo autom√°tico. Por favor no responder.</p>\n    </div>\n</body>\n</html>",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        1616,
        224
      ],
      "id": "f1a00e61-3204-4529-b965-6d8ddfc19830",
      "name": "Send a message",
      "webhookId": "079a17ca-4cde-44a7-a817-03dec143698b",
      "credentials": {
        "gmailOAuth2": {
          "id": "cDsRAWI7wL2LMm0z",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "citas",
          "mode": "list",
          "cachedResultName": "citas"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "nombre_cliente": "={{ $json.body.nombre }}",
            "telefono": "={{ $json.body.telefono }}",
            "email": "={{ $json.body.email }}",
            "tipo_servicio": "={{ $json.body.tipo_servicio }}",
            "direccion": "={{ $json.body.direccion }}",
            "fecha_entrega": "={{ $json.body.fecha_preferida }}",
            "hora_inicio": "={{ $json.hora_inicio }}",
            "hora_fin": "={{ $json.hora_fin }}",
            "estado": "={{ $json.estado }}",
            "created_at": "={{ $now }}",
            "notas": "={{ $json.body.notas }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "nombre_cliente",
              "displayName": "nombre_cliente",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telefono",
              "displayName": "telefono",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "tipo_servicio",
              "displayName": "tipo_servicio",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "direccion",
              "displayName": "direccion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "fecha_entrega",
              "displayName": "fecha_entrega",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "hora_inicio",
              "displayName": "hora_inicio",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "time",
              "canBeUsedToMatch": true
            },
            {
              "id": "hora_fin",
              "displayName": "hora_fin",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "time",
              "canBeUsedToMatch": true
            },
            {
              "id": "notas",
              "displayName": "notas",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "estado",
              "displayName": "estado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "outputColumns": [
            "*"
          ]
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        672,
        224
      ],
      "id": "b846b41a-1e00-464d-95c9-49c946bc3893",
      "name": "Insertar Cita",
      "credentials": {
        "postgres": {
          "id": "U1gk6gNtS2AfXBnb",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:5678/webhook/procesar-cotizacion",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "cita_id",
              "value": "=={{ $('Insertar Cita').first().json.id }}"
            },
            {
              "name": "cotizacion_data",
              "value": "=={{ $json.cotizacion_data }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        0,
        0
      ],
      "id": "937cd427-9c4b-4be0-9bfa-d06400d201a2",
      "name": "Llamar Flujo Cotizacion",
      "disabled": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"cita_id\": {{ $json.cita_id }},\n\"event_id\": \"{{ $json.event_id }}\"\n} ",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        1344,
        224
      ],
      "id": "2bd0ddb9-21b4-47d4-b946-a7f8b44f6e4c",
      "name": "Respond to Webhook"
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Validar Cita",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create an event": {
      "main": [
        [
          {
            "node": "Formatear Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Construir DateTime": {
      "main": [
        [
          {
            "node": "Insertar Cita",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Cita": {
      "main": [
        [
          {
            "node": "Construir DateTime",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insertar Cita": {
      "main": [
        [
          {
            "node": "Create an event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond to Webhook": {
      "main": [
        [
          {
            "node": "Send a message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": null,
  "meta": null,
  "pinData": {},
  "versionId": "db437ab1-b0de-4ea1-b631-ee8a9cfe61d7",
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2025-11-28T20:55:19.764Z",
      "createdAt": "2025-11-28T20:55:19.764Z",
      "role": "workflow:owner",
      "workflowId": "8gP78fW1rv7UB5v9",
      "projectId": "WR6tkeQzo7cAVCK0"
    }
  ],
  "tags": []
}